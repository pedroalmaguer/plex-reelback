<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Stats</title>
    <!-- Modern font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/styles.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- User selection overlay (shown first) -->
    <div id="user-select-overlay" class="overlay">
        <div class="select-container">
            <h1>Welcome to Your Movie Year in Review</h1>
            <form id="user-form" method="post" action="/set_user">
                <select id="user" name="user_id">
                    <option value="" disabled {% if not session.get('user_id') %}selected{% endif %}>Choose your profile</option>
                    {% for user in users %}
                    <option value="{{ user.user_id }}" {% if session.get('user_id') == user.user_id %}selected{% endif %}>
                        {{ user.username }}
                    </option>
                    {% endfor %}
                </select>
                <button type="button" onclick="startExperience()">Start Your Experience</button>
            </form>
        </div>
    </div>

    <!-- Main content (initially hidden) -->
    <div id="stats-experience" class="hidden">
        <div class="sections-container">
            <section class="stat-section" id="overview">
                <div class="stat-content"></div>
            </section>
            
            <section class="stat-section" id="most-popular">
                <div class="stat-content"></div>
            </section>

            <section class="stat-section" id="movies-2024">
                <div class="stat-content"></div>
            </section>

            <section class="stat-section" id="last-watched">
                <div class="stat-content"></div>
            </section>
        </div>

        <!-- Progress indicator -->
        <div class="progress-dots">
            <span class="dot active"></span>
            <span class="dot"></span>
            <span class="dot"></span>
            <span class="dot"></span>
        </div>
    </div>

    <script>
        let currentSection = 0;
        const sections = document.querySelectorAll('.stat-section');
        
        function startExperience() {
            const userId = document.getElementById('user').value;
            console.log('Selected user ID:', userId); // Debug log
            
            if (!userId) {
                alert('Please select a user first');
                return;
            }

            // Create FormData for the request
            const formData = new FormData();
            formData.append('user_id', userId);

            // First set the user
            fetch('/set_user', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                console.log('Response status:', response.status); // Debug log
                return response.json().then(data => ({
                    ok: response.ok,
                    data: data
                }));
            })
            .then(({ok, data}) => {
                console.log('Response data:', data); // Debug log
                
                if (ok && data.success) {
                    // Remove the overlay and show content
                    document.getElementById('user-select-overlay').classList.add('fade-out');
                    document.getElementById('stats-experience').classList.remove('hidden');
                    
                    // Load all sections
                    loadSection('/stats_overview', 'overview');
                    loadSection('/most_popular', 'most-popular');
                    loadSection('/movies_2024', 'movies-2024');
                    loadSection('/last_watched', 'last-watched');
                } else {
                    throw new Error(data.error || 'Failed to set user');
                }
            })
            .catch(error => {
                console.error('Error setting user:', error);
                alert('Error setting user. Please try again. Details: ' + error.message);
            });
        }

        function loadSection(endpoint, sectionId) {
            fetch(endpoint, { method: 'POST' })
                .then(response => response.text())
                .then(html => {
                    document.querySelector(`#${sectionId} .stat-content`).innerHTML = html;
                });
        }

        // Handle scrolling between sections
        window.addEventListener('wheel', handleScroll);
        window.addEventListener('keydown', handleKeyPress);

        function handleScroll(e) {
            e.preventDefault();
            if (e.deltaY > 0) nextSection();
            else if (e.deltaY < 0) previousSection();
        }

        function handleKeyPress(e) {
            if (e.key === 'ArrowDown' || e.key === 'ArrowRight') nextSection();
            else if (e.key === 'ArrowUp' || e.key === 'ArrowLeft') previousSection();
        }

        function updateSection(index) {
            sections.forEach((section, i) => {
                section.style.transform = `translateY(${100 * (i - index)}%)`;
            });
            
            // Update progress dots
            document.querySelectorAll('.dot').forEach((dot, i) => {
                dot.classList.toggle('active', i === index);
            });
        }

        function nextSection() {
            if (currentSection < sections.length - 1) {
                currentSection++;
                updateSection(currentSection);
            }
        }

        function previousSection() {
            if (currentSection > 0) {
                currentSection--;
                updateSection(currentSection);
            }
        }
    </script>
</body>
</html>